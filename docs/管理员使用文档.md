# LibreDomains 管理员使用文档

## 部署指南

### 1. 准备工作

#### 必需账户和服务
- **Cloudflare 账户**: 用于 DNS 管理和 Pages 部署
- **GitHub 账户**: 用于代码托管和自动化
- **域名**: 至少一个托管在 Cloudflare 的域名

#### 获取 API 密钥
1. 登录 Cloudflare Dashboard
2. 前往 "我的个人资料" > "API 令牌"
3. 创建自定义令牌，权限设置：
   - **区域:DNS:编辑** (针对你的域名)
   - **账户:Cloudflare Pages:编辑**

### 2. 快速部署

#### 方法一：GitHub + Cloudflare Pages（推荐）

1. **Fork 仓库**
   ```bash
   # 访问 https://github.com/yourusername/LibreDomains-beta
   # 点击右上角 "Fork" 按钮
   ```

2. **配置 Cloudflare Pages**
   - 登录 Cloudflare Dashboard
   - 前往 "Pages" > "创建项目"
   - 连接到 GitHub 并选择你的仓库
   - 构建设置：
     ```
     框架预设: Next.js (Static HTML Export)
     构建命令: npm run build
     输出目录: out
     根目录: /
     ```

3. **设置环境变量**
   在 Cloudflare Pages 项目设置中添加：
   ```
   CLOUDFLARE_API_TOKEN=your_api_token
   CLOUDFLARE_ACCOUNT_ID=your_account_id  
   ADMIN_PASSWORD=your_secure_password
   NEXT_PUBLIC_BASE_URL=https://your-project.pages.dev
   ```

4. **配置域名**
   编辑 `config/domains.json`：
   ```json
   {
     "domains": [
       {
         "name": "your-domain.com",
         "enabled": true,
         "description": "主要域名",
         "cloudflare_zone_id": "your_zone_id_here"
       }
     ]
   }
   ```

5. **部署完成**
   - 推送代码变更会自动触发部署
   - 访问 `https://your-project.pages.dev` 查看效果

#### 方法二：手动部署

```bash
# 1. 克隆仓库
git clone https://github.com/yourusername/LibreDomains-beta.git
cd LibreDomains-beta

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env.local
# 编辑 .env.local 填入配置

# 4. 构建项目
npm run build

# 5. 使用 Wrangler 部署
npm install -g wrangler
wrangler login
wrangler pages deploy out --project-name libredomains
```

### 3. 管理员面板使用

#### 访问管理面板
1. 访问 `https://your-domain.pages.dev/admin`
2. 使用 `ADMIN_PASSWORD` 环境变量中设置的密码登录

#### 域名管理
- **添加域名**: 输入域名信息和 Cloudflare Zone ID
- **启用/禁用域名**: 控制域名是否出现在用户申请页面
- **查看域名状态**: 监控各域名的启用状态

#### 子域名审核
- **查看申请**: 查看所有待审核和已审核的子域名申请
- **审核通过**: 点击"审核通过"按钮批准申请
- **删除记录**: 删除不当或测试用的子域名记录

### 4. 高级配置

#### 自动化审核
在 `config/domains.json` 中设置：
```json
{
  "settings": {
    "auto_approve": true,
    "max_subdomains_per_user": 10
  }
}
```

#### Cloudflare DNS API 集成
创建 `scripts/dns-sync.js` 实现真实的 DNS 记录操作：

```javascript
const cloudflare = require('cloudflare');

async function createDNSRecord(zoneId, record) {
  const cf = cloudflare({
    token: process.env.CLOUDFLARE_API_TOKEN
  });
  
  return await cf.dnsRecords.add(zoneId, {
    type: record.type,
    name: record.domain,
    content: record.content,
    ttl: record.ttl,
    proxied: record.proxied
  });
}
```

#### GitHub Actions 集成
创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy to Cloudflare Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '18'
    - run: npm install
    - run: npm run build
    - uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: libredomains
        directory: out
```

### 5. 监控和维护

#### 日志监控
- 查看 Cloudflare Pages 部署日志
- 监控 DNS 查询统计
- 关注用户申请趋势

#### 定期维护
- 清理过期的申请记录
- 更新域名配置
- 检查 API 额度使用情况

#### 备份策略
- 定期备份 `config/domains.json`
- 备份 `subdomains/` 目录
- 使用 Git 进行版本控制

### 6. 故障排除

#### 常见问题

**部署失败**
- 检查环境变量配置
- 验证 API 令牌权限
- 查看构建日志

**DNS 记录不生效**
- 确认 Cloudflare Zone ID 正确
- 检查 API 令牌权限
- 验证域名解析设置

**管理面板访问失败**
- 检查 `ADMIN_PASSWORD` 环境变量
- 清除浏览器缓存
- 查看控制台错误信息

#### 技术支持

如需技术支持，请提供：
- 错误信息截图
- 环境变量配置（隐藏敏感信息）
- 操作步骤详述

## 安全建议

1. **强密码**: 使用复杂的管理员密码
2. **API 权限**: 最小化 API 令牌权限范围
3. **定期更新**: 及时更新依赖包版本
4. **访问限制**: 考虑添加 IP 白名单限制
5. **监控告警**: 设置异常访问告警

## 许可和合规

- 确保域名使用符合相关法律法规
- 监控子域名使用情况，及时处理滥用
- 保留用户申请日志以备审计

---

需要帮助？请联系技术支持或查看项目文档。
